<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nested Events and Payments Tree</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      display: flex;
    }

    #treeContainer {
      width: 400px;
      border-right: 1px solid #ccc;
      padding-right: 10px;
    }

    .frame {
      border: 1px solid #ccc;
      border-radius: 5px;
      margin-bottom: 10px;
      padding: 10px;
      cursor: pointer;
      background-color: #f9f9f9;
      transition: background-color 0.3s ease;
    }

    .frame:hover {
      background-color: #e9e9e9;
    }

    .subTree {
      margin-top: 10px;
      display: none;
    }

    .subTree.active {
      display: block;
    }

    .paymentDetails {
      display: none; /* Initially hide payment details */
      margin-top: 10px;
    }

    ul {
      list-style-type: none;
      padding-left: 20px;
    }

    li {
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <div id="treeContainer">Loading data...</div>

  <script>
    // Fetch data from the backend
    async function fetchData(endpoint) {
      const response = await fetch(`https://stripebackend-production-0a48.up.railway.app/${endpoint}`);
      if (!response.ok) {
        throw new Error(`Failed to load data from ${endpoint}`);
      }
      return await response.json();
    }

    // Convert Firestore timestamp to readable format
    function convertTimestamp(timestamp) {
      const date = new Date(timestamp._seconds * 1000); // Convert seconds to milliseconds
      return date.toLocaleString(); // Returns a readable date format (localized)
    }

    // Recursive function to process nested events and attach payments
    function createEventTree(events, paymentsByEvent, parentElement) {
      const ul = document.createElement('ul');
      parentElement.appendChild(ul);

      events.forEach(event => {
        const eventFrame = document.createElement('div');
        eventFrame.classList.add('frame');
        eventFrame.innerText = event.id || event._id;

        // Sub-tree for this event
        const eventSubTree = document.createElement('div');
        eventSubTree.classList.add('subTree');

        // Attach payments related to this event
        const paymentsForEvent = paymentsByEvent[event.id] || [];
        paymentsForEvent.forEach(payment => {
          const paymentFrame = document.createElement('div');
          paymentFrame.classList.add('frame');
          paymentFrame.innerText = `OrderID: ${payment.orderid} - ${payment.name}`;

          const paymentDetails = document.createElement('div');
          paymentDetails.classList.add('paymentDetails');

          const paymentList = document.createElement('ul');
          Object.entries(payment).forEach(([key, value]) => {
            // Skip 'subcollections'
            if (key === 'subcollections') return;

            // Check if the key is 'created' and convert the timestamp to a readable format
            if (key === 'created' && value._seconds && value._nanoseconds) {
              const readableTimestamp = convertTimestamp(value);
              const detailLi = document.createElement('li');
              detailLi.innerText = `${key}: ${readableTimestamp}`;
              paymentList.appendChild(detailLi);
            } else {
              // Normal behavior for other keys
              const detailLi = document.createElement('li');
              detailLi.innerText = `${key}: ${value}`;
              paymentList.appendChild(detailLi);
            }
          });

          paymentDetails.appendChild(paymentList);
          paymentFrame.appendChild(paymentDetails);

          // Add event listener to toggle visibility of payment details on click
          paymentFrame.addEventListener('click', () => {
            paymentDetails.classList.toggle('paymentDetails'); // Toggle visibility of details
          });

          eventSubTree.appendChild(paymentFrame);
        });

        // Recursively process sub-events
        if (event.subcollections && event.subcollections['->']) {
          createEventTree(event.subcollections['->'], paymentsByEvent, eventSubTree);
        }

        eventFrame.addEventListener('click', () => {
          eventSubTree.classList.toggle('active');
        });

        ul.appendChild(eventFrame);
        ul.appendChild(eventSubTree);
      });
    }

    // Initialize the tree
    async function init() {
      try {
        const [events, payments] = await Promise.all([
          fetchData('read-data/Events'),
          fetchData('read-data/payments')
        ]);

        // Group payments by eventid
        const paymentsByEvent = payments.reduce((acc, payment) => {
          const eventid = payment.eventid || 'unknown';
          if (!acc[eventid]) acc[eventid] = [];
          acc[eventid].push(payment);
          return acc;
        }, {});

        const container = document.getElementById('treeContainer');
        container.innerHTML = ''; // Clear loading text
        createEventTree(events, paymentsByEvent, container);
      } catch (error) {
        const container = document.getElementById('treeContainer');
        container.innerText = `Error loading data: ${error.message}`;
        console.error(error);
      }
    }

    init();
  </script>
</body>
</html>
